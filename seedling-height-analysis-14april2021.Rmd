---
title: "seedling height analysis"
author: "Peter Smallidge"
date: "10/16/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Analysis of seedling heights 2018 & 2019


```{r, include=FALSE}

library(tidyverse)
library(skimr)        ## install.packages("skimr")
library(dplyr)
#
# ALT plus hypen = <- (within chunk)
# ctrl plus shift plus m = %>% 
# ctrl + ALT + I = insert chunk
# filter rows, select columns
# 

```

### read data from csv file, check variables and data structure

<!-- note to self: in the "read_csv" code, after the file location the code
for 'col..." etc ensures that the specified column is adjusted
the file "cheat sheet data-import" has details 

It is also possible to right-click a file name and import excel
-->


```{r}
#input.data = read_csv("~/R/slash-wall-vegetation/height-data-2019.csv",
#                      col_types=cols(spp=col_character()))

library(readr)
height_data_2019 <- read_csv("height-data-2019.csv", 
    col_types = cols(
      season = col_integer(),
      point = col_integer(),
      spp = col_character(),
      yr.curr = col_integer(),
      yr.prev = col_integer()
      ))
view(height_data_2019)


str(height_data_2019)

ht.data <- height_data_2019 %>% 
  rename(ht.2019 = tot.ht)  #change variable names (new name = old name)

table(ht.data$spp)
table(ht.data$origin)

glimpse(ht.data)

skim(ht.data)
#str(ht.data)  there are 1158 rows in original data frame
head(ht.data)
#dim(ht.data)

```


### Make the data tidy
### Use separate data by year, then stack using "bind_rows"
```{r}

# seedling heights were measured after the 2019 growing season
# the height of the seedling at end of 2019 recorded as ht.2019
# the growth increment for 2019 = inc.2019
# the growth increment for 2019 = inc.2018

# calculate seedling heights for 2017 and 2018
ht.data2 <- ht.data %>% 
  mutate(
    ht.2018 = ht.2019 - inc.2019,
    ht.2017 = ht.2018 - inc.2018,
    yr.original = 2017
  )
#   

head(ht.data2)

# clean up variable names to allow for "bind_row"
data2019 <- ht.data2 %>% 
  select(harvest, season, samp.date, location, point, spp, origin, basal.dia, ht.2019) %>% 
  rename(
    date = samp.date,
    height = ht.2019,
    year = season,
    basal2019 = basal.dia
  )
str(data2019)

data2018 <- ht.data2 %>% 
  select(harvest, season, samp.date, location, point, spp, origin, basal.dia, ht.2018) %>% 
  rename(
    date = samp.date,
    height = ht.2018,
    basal2019 = basal.dia,
    year = season
  )
    data2018$year = 2018
  str(data2018)
  
data2017 <- ht.data2 %>% 
  select(harvest, season, samp.date, location, point, spp, origin, basal.dia, ht.2017, yr.original) %>% 
  rename(
    date = samp.date,
    height = ht.2017,
    basal2019 = basal.dia,
    year = yr.original
  )

seedling_orig <- bind_rows(data2019, data2018, data2017) %>% 
  select(-season) %>% 
  mutate_at(vars(harvest, year, location, spp, origin),
            list(factor)
            )  #make these variables into factors
str(seedling_orig)

# recode a factor https://r4ds.had.co.nz/factors.html 
 
seedling <- seedling_orig %>% 
 mutate(harvest = fct_recode(harvest,
                             "gas_line" = "CGL",
                              "red_pine" = "CRP",
                              "wedge_boot" = "CWB",
                              "red_pine" = "RP",
                              "gas_line" = "GL",
                              "boot" = "Boot",
                              "wedge" = "W"
)) 
# the "fct_recode is to create uniform names for the harvest sites which are differentiated by "location. "new value" = "old value"
# for interior, perimeter, or control


# levels(seedling$harvest) # confirming factors recoded
# str(seedling)
# levels(seedling$spp) # obtain list of species number codes to recode as alpha


#recode the factor "species" so values are alpha not numeric
#
seedling <- seedling %>% 
  mutate(spp = fct_recode(spp,
                          "ab" = "531",
                          "sm" = "318",
                          "rm" = "316",
                          "rp" = "125",
                          "wp" = "129",
                          "svb" = "356",
                          "yb" = "371",
                          "sb" = "372",
                          "pb" = "375",
                          "wa" = "541",
                          "yp" = "621",
                          "cu" = "651",
                          "la" = "70",
                          "asp" = "740",
                          "bc" = "762",
                          "wo" = "802",
                          "co" = "832",
                          "ro" = "833",
                          "bl" = "901",
                          "ba" = "951",
                          ))

levels(seedling$spp)
head(seedling)

# datafile "seedling" is now tidy
# 
# 

seedling %>% 
  write_csv(path = "tidy_seedling_heights_2017-2019.csv")

write_csv(seedling, "tidy2_seedling_heights_2017-2019.csv")

#both previous options work to write to an external
#file

```

Determine average height of seedlings by harvest, location


```{r}

ht.avg.interior <- seedling %>% 
  select(harvest, year, location, spp, origin, basal2019, height) %>%
  filter(year == "2019" & location == "interior") %>% 
  group_by(harvest) %>% 
  summarise(
    avg_ht = mean(height, na.rm=TRUE),
    n = n()  #mean(n, na.rm=TRUE)
  ) %>% 
  filter(n>9)
  
head(ht.avg.interior)  

ht.avg <- seedling %>%
  select(harvest, year, location, spp, origin, basal2019, height) %>%
  filter(year == "2019") %>% 
  group_by(harvest, location, origin, spp) %>% 
  #add_count(spp) %>% 
  summarise(
    avg_ht = mean(height, na.rm=TRUE),
    n = n()  #mean(n, na.rm=TRUE)
  ) %>% 
  filter(n > 9)
  
head(ht.avg, n=12) 
view(ht.avg)

ggplot(ht.avg) +
  geom_col(mapping = aes(spp, avg_ht))
  

```
<!--     

comments
  
-->



### Determine average total height at end of 2019

```{r}
# determine average total height and annual increment by harvest, origin, and spp
# 1. filter to retain priority species
# 2. select numeric variable
# 3. group by harvest, origin, and spp
# 4. summarize
ht.avg <- ht.data %>% 
  filter(spp == "531" |spp == "316" | spp == "318" | spp == "356" | spp == "372" |
          spp == "375" |spp ==  "541" | spp ==  "621" | spp ==  "743" | spp ==  "761" |
            spp == "762" | spp == "833" | spp == "951") %>% 
  select(harvest, origin, spp, ht.2019, inc.2019, inc.2018, basal.dia) %>% 
  group_by(harvest, origin, spp) %>% 
  add_count(spp) %>% 
  summarise(
    ht.2019 = mean(ht.2019),
    inc.2019 = mean(inc.2019),
    n=n()
  )
  
  

(ht.avg)


dim(ht.avg)
  

```

### Calcuate Species Heights for Boot and Wedge Combined VS Control Plots

```{r}
# mean height values for select species in boot or wedge harvests vs. controls of boot/wedge
# 1. import ht.data, all values
# 2. filter beech plus desired species
# 3. filter rows of data from boot, wedge or their control areas
# 4. filter to retain interior or control plots
# 5. select to retain focal variables
# 6. group by location (interior vs. control) and by species
# 7. count and summarize total height (ht.2019)

glimpse(ht.data)
tail(ht.data)
table(ht.data$harvest) # display the values in the variable "harvest"

ht.avg.boot.wedge <- ht.data %>% 
  filter(spp == "531" |spp == "316" | spp == "318" | spp == "356" | spp == "372" |
          spp == "375" |spp ==  "541" | spp ==  "621" | spp ==  "743" | spp ==  "761" |
            spp == "762" | spp == "833" | spp == "951") %>% 
  filter(harvest == "Boot" | harvest == "W" | harvest == "CWB") %>% 
  #(ht.avg.boot.wedge)
  #
  
  filter(location == "interior" | location == "control") %>% 
  #(ht.avg.boot.wedge)
  #

  select(harvest, location, origin, spp, ht.2019, inc.2019, inc.2018, basal.dia) %>% 
  
  group_by( location, spp) %>% 
  add_count(spp) %>% 
  summarise(
    ht.2019 = mean(ht.2019),
    inc.2019 = mean(inc.2019),
    n=n()
  )

(ht.avg.boot.wedge)

write.table(ht.avg.boot.wedge, "boot_wedge_ht.txt", sep="\t")

```



### Calcuate Species Heights for Gas Line Interior VS Control Plots

```{r}

# mean height values for select species in gas line harvests vs. controls of gas line

# 1. import ht.data, all values
# 2. filter beech plus desired species
# 3. filter rows of data from gas line or their control areas
# 4. filter to retain interior or control plots
# 5. select to retain focal variables
# 6. group by location (interior vs. control) and by species
# 7. count and summarize total height (ht.2019)

#glimpse(ht.data)
#tail(ht.data)
table(ht.data$harvest) # display the values in the variable "harvest"

ht.avg.gasline <- ht.data %>% 
  filter(spp == "531" |spp == "316" | spp == "318" | spp == "356" | spp == "372" |
          spp == "375" |spp ==  "541" | spp ==  "621" | spp ==  "743" | spp ==  "761" |
            spp == "701" | spp == "762" | spp == "833" | spp == "951") %>% 
 #glimpse(ht.avg.gasline), spp 701 = Ostrya
  
  
  filter(harvest == "GL" | harvest == "CGL") %>% 
 #glimpse(ht.avg.gasline)
  
  
  filter(location == "interior" | location == "control") %>% 
# glimpse(ht.avg.gasline)
  

  select(harvest, location, origin, spp, ht.2019, inc.2019, inc.2018, basal.dia) %>% 
  
  group_by( location, spp) %>% 
  add_count(spp) %>% 
  summarise(
    ht.2019 = mean(ht.2019),
    inc.2019 = mean(inc.2019),
    n=n()
  )

#glimpse(ht.avg.gasline)

write.table(ht.avg.gasline, "gasline_ht.txt", sep="\t")

```








### Visualize data relationships

```{r}

library(ggplot2)

ht.data.com <- ht.data %>% 
  filter(spp == "531" |spp == "316" | spp == "318"  | spp == "372" |
           spp ==  "541"  |
            spp == "762" | spp == "833" | spp == "951") 

ggplot(data=ht.data.com, mapping = aes(x=basal.dia, y = ht.2019, size = spp)) +
  geom_point(mapping = aes(size = spp), shape = 1) +
  geom_smooth(method="lm", se=F) +
  facet_wrap(~origin, nrow=1) +
  theme_bw()


```

```{r}
ht.data.com %>% 
  filter(spp==531) %>% 
  group_by(origin) %>% 
  ggplot()+
    geom_boxplot(mapping=aes(x=spp, y=ht.2019))
```

